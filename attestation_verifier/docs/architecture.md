# Architecture

This document shows the overall architecture and the data flow of the demo

## Scenario

In this demo, we are implementing a SecretStore. To prevent server admin from accessing the secret, the SecretStore only allows the AWS Nitro Enclave to access it.

To achieve it, we are going to use attestation document to verify the identity of the enclave image, and use RSA to encrypt the secret sent from the SecretStore to the enclave.

## Component

- Client

   The client app is used for user interaction. It sends a command to server to kickstart the secret retrieval process, and wait for server to send back the secret.

- Server

   The server app is running inside the enclave. It generate the attestation document to identify itself, and connect to SecretStore to get the secret.

- SecretStore

   SecretStore is the place to store the secret. Normally, it will be sitting in other places like a central server. But for simplicity, I put it in the same instance, but it would not (and should not) communitcate with the client directly.

   Once the SecretStore receive a request from Server app, it will validate the attestaion document:

   1. **Match the PCRs** - To check if the request is generated by the desired enclave image

   1. **Validate signature** - To ensure the integrity of the request, i.e. the request has not been modified

   1. **Validate the certificate** - To ensure the request is signed by a valid certificate under the AWS Nitro Attestation Public Key Infrastructure (PKI). It is done by validating the certificate against the [root certificate](https://aws-nitro-enclaves.amazonaws.com/AWS_NitroEnclaves_Root-G1.zip) provided by AWS

## Diagram

![Architecture](https://github.com/richardfan1126/nitro-enclave-python-demo/blob/master/attestation_verifier/docs/assets/Architecture.png)

1. The client app send a command to the server running in enclave.

1. The server app generate an encryption keypair that will be used by the SecretStore for encryption later.

1. The server app call Nitro Secure Module (NSM) of the enclave to generate an attestation document.

   This document includes the enclave measurement and the public key genereated in step 2.
   
   The document will be signed by enclave certificate.

1. The server send the attestation document to SecretStore.

1. SecretStore validite the attestation document.

   It uses CBOR Object Signing and Encryption (COSE), AWS Nitro Attestation Public Key Infrastructure (PKI) and PCRs matching to make sure the request is generated by the correct enclave.

   SecretStore will then use the public key, which is embeded inside the attestation document, to encrypt the plaintext secret.

1. SecretStore send the encrypted secret to enclave server.

1. Enclave server use the private key to decrypt the secret, then send it back to client.