
# AWS Nitro Enclaves Python demo - Attestation Verifier

**WARNING: This project is just proof-of-concept, not production-ready, use at your own risk.**

This project showcase how we can validate the attestation document generated by AWS Nitro Enclaves' Nitro Secure Module (NSM).

## Contributors

- [donkersgoed](https://github.com/donkersgoed)

   `server/libnsm.so` is from [this repository](https://github.com/donkersgoed/aws-nitro-enclaves-nsm-api/commit/112a450082d108bf466ca57e687beaaeff19db4a). He modified the original one to make it usable in Python.

   `server/NsmUtil.py` is based on donkersgoed's project [NitroPepper](https://github.com/donkersgoed/nitropepper-enclave-app), more detail about his project on [Ultra Secure Password Storage with NitroPepper](https://www.sentiatechblog.com/ultra-secure-password-storage-with-nitropepper)

## Architecture

See [Architecture diagram](https://github.com/richardfan1126/nitro-enclave-python-demo/blob/master/attestation_verifier/docs/architecture.md)

## Installation guide

1. Create an EC2 instance with Nitro Enclave enabled. See [AWS documentation](https://docs.aws.amazon.com/enclaves/latest/user/create-enclave.html) for steps and requirement.

   Amazon Linux 2 AMI is recommended.

1. SSH into the instance. Install `nitro-cli`

   ```
   $ sudo amazon-linux-extras install aws-nitro-enclaves-cli
   $ sudo yum install aws-nitro-enclaves-cli-devel -y
   $ sudo usermod -aG ne $USER
   $ sudo usermod -aG docker $USER
   ```

1. Modify the preallocated memory for the enclave to 2048 MB.

   Modify the file `/etc/nitro_enclaves/allocator.yaml`, change the following line:

   ```
   # memory_mib: 512
   memory_mib: 2048
   ```

1. Enable Docker and Nitro Enclaves Allocator

   ```
   $ sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
   $ sudo systemctl start docker && sudo systemctl enable docker
   ```

1. Reboot the instance

1. Login to the instance, clone the repository

   ```
   $ git clone https://github.com/richardfan1126/nitro-enclave-python-demo.git
   ```

1. Use the build script to build the enclave image

   ```
   $ cd nitro-enclave-python-demo/attestation_verifier/server
   $ chmod +x build.sh
   $ ./build.sh
   ```

1. After the image is built, you can find the measurement of it

   Find the following line, and take note the `PCR0` value

   ```
   Enclave Image successfully created.
   {
     "Measurements": {
       "HashAlgorithm": "Sha384 { ... }",
       "PCR0": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
       "PCR1": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
       "PCR2": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
     }
   }
   ```

1. Run the enclave

   ```
   $ nitro-cli run-enclave --cpu-count 2 --memory 2048 --eif-path nitro-enclave-python-demo.eif
   ```

1. After the enclave has launched, you can find the CID of it.

   Find the following line, and take note the `enclave-cid` value

   ```
   Started enclave with enclave-cid: 16, memory: 1024 MiB, cpu-ids: [1, 3]
   ```

1. Open a new SSH session, install python3 and the necessary packages for running SecretStore app

   ```
   $ yum install python3 -y
   $ cd nitro-enclave-python-demo/attestation_verifier/secretstore/
   $ python3 -m venv venv
   $ source venv/bin/activate
   $ pip install -r requirements.txt
   ```

1. Run the SecretStore app, replace `<pcr0>` with the `PCR0` value you get in step 8

   ```
   $ python3 secretstore.py <pcr0>
   ```

1. Open another SSH session, run the client app, replace `<cid>` with the enclave CID you get in step 10

   ```
   $ cd nitro-enclave-python-demo/attestation_verifier/client
   $ python3 client.py <cid>
   ```

1. If everthing is OK, you will see the secret plaintext shown in the console output.

## File structure

TBD